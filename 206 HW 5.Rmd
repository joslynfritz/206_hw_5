---
title: "206 HW 5"
author: "Joslyn Fritz"
date: "11/28/2018"
output:
  html_document: default
  pdf_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages and files, echo = FALSE, include = FALSE}

library(tidyverse)
library(stargazer)
library(kableExtra)
library(tidyr)
library(vcdExtra)
library(car)
library(onewaytests)
library(gridExtra)
library(kableExtra)
library(effsize)
library(ggplot2)
library(ggsignif)

faculty_salary <- read_csv("Faculty salary data.csv")

med_salary <- read_csv("Median salary for doctorals.csv")

grad_enroll <- read_csv("Grad enrollment.csv")

phd_fields <- read_csv("PhDs by Field.csv")

```


#### 1. Compare trends in graduate enrollment (1967-2015)

```{r, echo = FALSE, include = FALSE}

# Exploratory graph

male_scatter <- ggplot(grad_enroll, aes(x = year, y = male_total)) +
  geom_point()
male_scatter

# Overall the data looks linear. There are some outliers that fall outside of linear, but I think a linear regression is ok

female_scatter <- ggplot(grad_enroll, aes (x = year, y = female_total)) +
  geom_point()
female_scatter

# Overall the data looks linear. There are some outliers that fall outside of linear, but I think a linear regression is ok

```

```{r, echo = FALSE, include=FALSE}

# Perform linear regression

male_model <- lm(male_total ~ year, data = grad_enroll)
male_model
summary(male_model)

# Total male enrollment = 9060*(year) - 17112153 

female_model <- lm(female_total ~ year, data = grad_enroll)
female_model
summary(female_model)

# Total female enrollment = 30126*(year) - 58955502

# multi-variable linear regression??
  
```

```{r, echo = FALSE, include = FALSE}

# Model diagnostics 

plot(male_model)
plot(female_model)

```

```{r, echo = FALSE, include=FALSE}

# Pearson's R

# H0: Correlation equals 0
# HA: Correlation does not equal 0

male_r <- cor.test(grad_enroll$male_total, grad_enroll$year)
male_r

female_r <- cor.test(grad_enroll$female_total, grad_enroll$year)
female_r

```

Male: t(47) = 16.61, p < 0.001. Reject the null. Correlation = 0.92, which is a strong positive correlation.

Year significantly predicts male graduate school enrollment (*b* = -17112153, t(`r male_r$parameter`) = `r round(male_r$statistic, 2)`, *p* < 0.001) with a strong positive correlation between the two (Pearson's *r* = `r round(male_r$estimate, 2)`). The overall model (Total gradute male enrollment = 9060(year) - 17112153) explains a significant amount of variance in male enrollment (F(1,47) = 276, *p* < 0.001, R^2^ = 0.85).

Female: t(47) = 51.66, p < 0.001. Reject the null. Correlation = 0.99, which is a strong positive correlation.

Year significantly predicts female graduate school enrollment (*b* = -17112153, t(`r male_r$parameter`) = `r round(male_r$statistic, 2)`, *p* < 0.001) with a strong positive correlation between the two (Pearson's *r* = `r round(male_r$estimate, 2)`). The overall model (Total gradute female enrollment = 30126(year) - 58955502) explains a significant amount of variance in male enrollment (F(1,47) = 2669, *p* < 0.001, R^2^ = 0.98).

```{r, echo = FALSE}

library(ggplot2)

# I tried to displaythe equations for each line on the graph but it was super hard and have given up for now

equation <-function(male_model){
  m <- lm(y ~ x, male_model);
  eq <- substitute(italic(y) == a + b %.% italic(x)*","~~italic(r)^2~"="~r2, 
         list(a = format(coef(male_model)[1], digits = 2), 
              b = format(coef(male_model)[2], digits = 2), 
             r2 = format(summary(male_model)$r.squared, digits = 3)))
as.character(as.expression(eq));
}


# Graph it

total_grad_mvf <- ggplot(grad_enroll, aes(x = year, y = male_total)) + 
  geom_point(aes(y = male_total, color = "Male")) +
  geom_point(aes(y = female_total, color = "Female")) +
  geom_smooth(method = lm, se = F, aes(col = "Male"))+
  geom_smooth(aes(x = year,  y = female_total, col = "Female"), method = lm, se = F)+
    xlab("Year") +
  ylab("Total Enrollment") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"), 
        text = element_text(family = "serif"))+
  theme(legend.text=element_text(size = 15)) +
  theme(legend.title=element_blank()) 
    
  
total_grad_mvf



# Find a way to rename legend



```


#### 2. Shifts in Phd recipients by field of study (1985, 2000, 2015)

```{r, echo = FALSE, include=FALSE}

phd_female <- phd_fields %>% 
  spread(year, number)%>%  # Spread out the year designations by number
  select(-gender, -field) # removed gender and field columns
phd_female

rownames(phd_female) <- c("Education", "Engineering", "Humanities & Art", "Physical Earth Sciences") # Change row names in df such that only numbers exist in the center


# Let's look at the actual proportions:

female_prop <- round(prop.table(as.matrix(phd_female), 1), 2) # Updates phd_female to a matrix for it to work in prop.table. The 1 is the margin over which to calculate proportion
female_prop


# Run a chi-squared test for independence

#H0: No significant difference between proportions in year

phd_female_chi2 <- chisq.test(phd_female)
phd_female_chi2



```


number of female phd recipients per field differed significantly between 1985 (n = ) and 2000 (n = ) and 2015 (n =) ($\chi^2${`r phd_female_chi2$parameter`} = ....., p < 0.001). Notably, ....

```{r, echo= FALSE}

# Make a table of proportions

#prop_table <- stargazer(female_prop, type = "html")
#prop_table

chi_table <- kable(female_prop, caption = "**Table 1. Proportions of female recipients who earned a Phd in 1985, 2000 and 2015.**") %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", full_width = F)) %>% 
  column_spec(1, width = "15em", bold = T) %>% 
  column_spec(2, width = "15em") %>% 
  column_spec(3, width = "15em") %>% 
   column_spec(4, width = "15em")
chi_table

```


#### 3. Male and female salaries for starting postdoc and other positions (2015)

Does median salary differ significantly between male and female starting postdoc positions? Does median salary differ significantly between male and female PhD recipients in non-postdoc employment positions?


```{r, echo = FALSE, include = FALSE}

# Exploratory graph

postdoc_med_salary <- med_salary %>%
  filter(status == "postdoc")

postdoc_hist <- ggplot(postdoc_med_salary, aes(x = male))+
  geom_histogram(bins = 6)
postdoc_hist

emp_med_salary <- med_salary %>% 
  filter(status == "employment")

emp_hist <- ggplot(emp_med_salary, aes(x = male)) +
  geom_histogram(bins = 6)
emp_hist

```

```{r, echo = FALSE, include=FALSE}

# Wilcoxon-Signed Ranked (non-parametric, paired)

# Ho: There is NOT a significant differnece in median salary for male and female starting postdoc positions.
# HA: There is a significant difference in mdeian salary for male and female starting postdoc positions.

wsr_postdoc <- wilcox.test(postdoc_med_salary$male, postdoc_med_salary$female, paired = TRUE)
wsr_postdoc


# Ho: There is NOT a significant differnece in median salary for male and female starting non-postdoc positions.
# HA: There is a significant difference in mdeian salary for male and female starting non-postdoc positions.

wsr_emp <- wilcox.test(emp_med_salary$male, emp_med_salary$female, paired = TRUE)
wsr_emp

```
There was no significant difference in median salary for male and female starting postdoc positions (W = 19.5, p = 0.884, alpha = 0.05)

There was a significant difference in median salary for male and female starting in non-post-doc employment positions (W = 101, p = 0.002, alpha = 0.05)

#### 4. Exploring academic salaries for professors in U.S. colleges

```{r, include= FALSE}

faculty_salary_model <- lm(Salary ~ Faculty_Rank + Years_Since_Phd + Years_Service + Sex, data = faculty_salary)
faculty_salary_model

faculty_salary_new <- faculty_salary %>% 
  mutate(
    Rank = case_when(
      Faculty_Rank == "Prof" ~ 1,
      Faculty_Rank == "AsstProf" ~ 2,
      Faculty_Rank == "AssocProf" ~ 3
    )
  ) %>% 
  mutate(sex = case_when(
      Sex == "Male" ~ 1,
      Sex == "Female" ~ 2
  )
  ) %>% 
  select(Years_Since_Phd, Years_Service, Salary, Rank, sex) 

  pairs(faculty_salary_new)

faculty_salary_new

# Years since phd and years in service are highly correlated and therefore one should be removed from the model:

faculty_salary_model2 <- lm(Salary ~ Faculty_Rank + Years_Since_Phd + Sex, data = faculty_salary)
faculty_salary_model2

faculty_salary_model$Faculty_Rank <- factor(faculty_salary_model$Faculty_Rank)

faculty_salary_model$Faculty_Rank <- fct_relevel(faculty_salary_model$Faculty_Rank, "Prof")

faculty_salary_model2 <- lm(Salary ~ Faculty_Rank + Years_Since_Phd + Sex, data = faculty_salary)
faculty_salary_model2


# Create a graph

df_new <- data.frame(Faculty_Rank = rep(c("Prof",
                                  "AsstProf",
                                  "AssocProf" Years_Since_Phd, 
                     Sex = rep(c("Male",
                                    "Female")))

# a. Make predictions using the new data frame:

salary_predict <- predict(faculty_salary_model2, newdata = df_new, se.fit = TRUE, interval = "confidence")

# b. Bind predictions to the data to make it actually useful:

predict_df <- data.frame(df_new, price_predict)
predict_graph <- ggplot(predict_df, aes(x= SqFt, y = fit.fit))+
  geom_line(aes(color = City))+
  facet_wrap(~Status)
predict_graph
```

